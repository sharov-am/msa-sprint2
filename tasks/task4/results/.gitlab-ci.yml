stages:
  - build
  - test
  - deploy

variables:
  IMAGE_TAG: latest
  IMAGE_NAME: booking-service

build:
  stage: build
  tags:
    - shell
  script:
      - helm lint ./helm/booking-service
      - docker build -t $IMAGE_NAME:$IMAGE_TAG ./booking-service
     


test:
  stage: test
  tags:
    - shell
  script:
    
    - docker run -d --name test_run_$CI_PIPELINE_ID $IMAGE_NAME:$IMAGE_TAG
    - sleep 5
    - docker exec test_run_$CI_PIPELINE_ID curl --fail http://localhost:8080/ping || (docker logs test_run_$CI_PIPELINE_ID && exit 1)
  after_script:
    - eval $(minikube docker-env)
    - docker rm -f test_run_$CI_PIPELINE_ID



deploy:
  stage: deploy
  tags:
    - shell
  script:
   - minikube image load $IMAGE_NAME:$IMAGE_TAG
   - echo "Deploying $IMAGE_NAME with tag $IMAGE_TAG"
   - helm upgrade --install $IMAGE_NAME ./helm/booking-service/ --set image.repository="$IMAGE_NAME"  --set image.tag="$IMAGE_TAG" --set image.pullPolicy=Never --wait
 